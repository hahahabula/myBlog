---
title: "S2.A/B测试"
description: "介绍有关A/B测试、随机分桶、分层实验、Holdout机制等内容"
date: 2025/2/13
categories: [搜广推, 王树森]
image: "./images/paste-2.png"
---

召回实验实现了一种GNN召回通道，离线实验结果正向，下一步做线上小流量A/B测试，考察新的召回通道对线上指标的影响。模型中有一些参数，比如GNN的深度取值 ${1,2,3}$ 需要用A/B测试选取最优参数。

# 随机分桶

全部n位用户分成b个桶：

1.  首先用`哈希函数`把用户ID映射成某个区间内的整数，然后把这些整数均匀分成b个桶；
2.  计算每个桶的业务指标比如DAU、人均使用推荐的时长、点击率，如果某个实验组指标显著优于对照组，则说明对于的策略有效，值得推全。

![随机分桶图](images/paste-1.png){fig-align="center" width="724"}

# 分层实验

各部门都需要做A/B测试，随机分成b个桶后，最后只能同时做b-1组实验：

-   分层实验：指召回、粗排、精排、重排、用户界面、广告这些层。
-   同层互斥：同召回层的多个实验不得在同一个桶内进行，防止一个桶同时被两个召回实验影响。
-   不同层互斥：每一层独立随机对用户做分桶。每一层都可以独立用全部的用户做实验

召回层分成 $u_1,\ldots,u_{10}$;精排层把用户分成 $v_1,\ldots,v_10$;一共n个用户，则有：

-   $u_1\cap u_j=\varnothing$
-   $|u_i\cap v_j|=\frac n {100}$

## 正交

如果所有实验都正交，则可以同时做无数组实验。

1.  同类的策略天然互斥，且它们的效果会相互增强1+1\>2或相互抵消(1+1\<2)
2.  不同类型的策略通常不互相干扰1+1=2可作为互斥的两层

# Holdout机制

1.  每个实验独立汇报对业务指标的提升。
2.  公司考察一个部门在一段时间内的业务指标、总体的提升。
3.  取10%的用户作为holdout桶，推荐系统使用剩余的90%的用户做实验，两者互斥。
4.  10%holdout桶 v.s. 90%实验桶的diff(需要归一化)为整个部门的业务指标收益

![Holdout机制示意图](images/paste-2.png){fig-align="center" width="845"}

-   每个考核周期结束之后，消除Holdout桶，让推全实验从90%用户扩大到100%的用户。
-   重新随机划分用户，得到holdout桶和实验桶，开始下一轮考核期。
-   新的holdout桶域实验桶的各种业务指标的diff接近0。
-   随着召回、粗排、精排、重排实验推全，diff会逐渐扩大。

# 实验推全和反转推全

在完成小流量测试后便需要实验推全又或者反转推全。

## 推全实验

![推全实验示意图](images/paste-3.png){width="551"}

在验证新策略有效时便可进行推全，此时将会新增一层“新层”与其他层正交，用以验证在全样本的情况下小流量实验结果。

## 反转推全

有些指标（点击、交互）立刻会得到新策略的反馈，而有的指标却存在滞后性需长期观测，此时可用反转实验再推全的新层中开一个旧策略的桶，长期观察实验指标。

![反转推全示意图](images/paste-4.png)